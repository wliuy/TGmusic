<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"><meta name="theme-color" content="#4d7c5f"><meta name="apple-mobile-web-app-capable" content="yes"><link rel="manifest" href="/manifest.json"><title>Sarah</title><link rel="icon" href="https://tc.yang.pp.ua/file/logo/sarah-y.png"><script src="https://cdn.tailwindcss.com"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;500;700;900&display=swap" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script><style>:root{--dynamic-accent:#d97706;--solara-text:#1e293b;--glass-blur:blur(40px);--m-green:#4d7c5f;--logo-url:url('https://tc.yang.pp.ua/file/logo/sarah(1).png');}body{color:var(--solara-text);font-family:'Noto Sans SC',sans-serif;height:100vh;margin:0;overflow:hidden;background:#fdf2f2;transition:background .8s;}#bg-stage{position:fixed;inset:0;z-index:-1;transition:background 1.5s cubic-bezier(.4,0,.2,1);will-change:background;}#lock-screen{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.1);backdrop-filter:blur(60px) brightness(.9);-webkit-backdrop-filter:blur(60px) brightness(.9);}#lock-screen.active{display:flex;}.auth-hidden{display:none!important;}.list-transition{opacity:1;transform:translateY(0);transition:opacity .3s,transform .3s;}.list-transition.entering{opacity:0;transform:translateY(15px);}.desktop-container{width:96%;max-width:1350px;height:82vh;background:linear-gradient(135deg,rgba(255,255,255,.15),rgba(255,255,255,.05));backdrop-filter:var(--glass-blur);border:1px solid rgba(255,255,255,.25);border-radius:24px;display:flex;flex-direction:column;padding:24px 44px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);justify-content:space-between;}.settings-corner{position:absolute;right:32px;top:25px;z-index:200;}.brand-title{font-size:3rem;font-weight:900;color:white;text-align:center;}.brand-sub{font-size:.85rem;font-weight:700;color:rgba(255,255,255,.6);text-align:center;margin-top:12px;}.search-panel{background:rgba(255,255,255,.15);border-radius:16px;padding:20px 36px;display:flex;gap:16px;align-items:center;}.search-capsule{flex:1;height:44px;background:rgba(255,255,255,.25);border-radius:12px;display:flex;align-items:center;padding-right:12px;}.search-input-field{flex:1;background:transparent;border:0;outline:none;padding:0 16px;font-weight:700;color:#1e293b;}.search-confirm-btn{background:var(--dynamic-accent);color:white;padding:0 32px;height:44px;border-radius:12px;font-weight:900;}.content-layout{flex:1;display:grid;grid-template-columns:.65fr 1fr 1fr;gap:24px;overflow:hidden;margin:10px 0;}.panel-box{background:rgba(255,255,255,.15);border-radius:16px;display:flex;flex-direction:column;overflow:hidden;}.song-item{padding:12px 16px;margin:3px 8px;border-radius:10px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:.2s;}.song-item.active{background:rgba(255,255,255,.3);color:var(--dynamic-accent);font-weight:900;}.lyrics-panel{flex:1;height:100%;mask-image:linear-gradient(to bottom,transparent,black 15%,black 85%,transparent);overflow-y:auto;scroll-behavior:smooth;text-align:center;display:flex;flex-direction:column;align-items:center;padding:45% 0;}.lrc-line{width:90%;padding:10px 14px;font-size:14px;font-weight:600;color:#475569;transition:.4s;opacity:.5;}.lrc-line.active{color:var(--dynamic-accent);background:rgba(255,255,255,.25);border-radius:10px;font-weight:900;opacity:1;transform:scale(1.1);}.footer-bar{height:90px;display:flex;align-items:center;padding:0 10px;gap:24px;}.btn-round{width:44px;height:44px;border-radius:50%;background:var(--dynamic-accent);display:grid;place-items:center;cursor:pointer;color:white;flex-shrink:0;}.btn-main{width:56px!important;height:56px!important;}.scrubber-area{flex:1;display:flex;align-items:center;gap:16px;margin:0 20px;}.rail{flex:1;height:6px;background:rgba(0,0,0,.08);border-radius:10px;position:relative;cursor:pointer;}.fill{height:100%;background:var(--dynamic-accent);border-radius:10px;width:0;position:relative;}.dot{position:absolute;right:-7px;top:50%;transform:translateY(-50%);width:14px;height:14px;background:white;border-radius:50%;border:2px solid var(--dynamic-accent);}.volume-control{width:150px;display:flex;align-items:center;gap:12px;}.cover-container{width:14rem;height:14rem;border-radius:1.5rem;overflow:hidden;margin-bottom:2rem;position:relative;background:rgba(255,255,255,.08);backdrop-filter:blur(30px);}.cover-img{width:100%;height:100%;object-fit:cover;z-index:10;position:absolute;inset:0;}.cover-placeholder{position:absolute;inset:0;z-index:5;background:var(--logo-url);background-size:cover;}.mobile-player-container{display:none;position:fixed;inset:0;z-index:100;flex-direction:column;padding:env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 10px;background:var(--m-green);}.m-header{height:50px;display:flex;align-items:center;justify-content:space-between;color:white;}.m-main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;}.m-disc-container{width:72vw;max-width:280px;aspect-ratio:1/1;position:relative;border-radius:50%;isolation:isolate;}.m-disc-clipping{position:absolute;inset:0;border-radius:50%;overflow:hidden;border:6px solid rgba(255,255,255,.12);animation:disc-rotate 25s linear infinite paused;}.playing .m-disc-clipping{animation-play-state:running;}@keyframes disc-rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}.m-lyrics-panel{height:120px;width:100%;mask-image:linear-gradient(to bottom,transparent 0%,black 25%,black 75%,transparent 100%);overflow-y:auto;display:flex;flex-direction:column;align-items:center;}.m-info-wrap{width:100%;text-align:center;color:white;margin-top:15px;}.m-controls-capsule{padding:0 15px 45px 15px;width:100%;}.m-drawer{position:fixed;bottom:-100%;left:0;width:100%;height:80vh;background:#4d7c5f;z-index:1000;border-radius:32px 32px 0 0;transition:.45s;display:flex;flex-direction:column;overflow:hidden;}.m-drawer.active{bottom:0;}.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(20px);z-index:2000;align-items:center;justify-content:center;}.modal.active{display:flex;}#admin-box{width:92%;max-width:900px;height:85vh;background:rgba(255,255,255,.08);backdrop-filter:blur(60px);border-radius:28px;display:flex;flex-direction:column;overflow:hidden;}.admin-song-row{display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(255,255,255,.05);border-radius:14px;margin-bottom:8px;cursor:grab;}.admin-song-row.is-dragging{position:fixed!important;z-index:10000!important;background:rgba(0,0,0,.7)!important;border:2px solid var(--dynamic-accent)!important;}.admin-song-placeholder{height:64px;border:2px dashed rgba(255,255,255,.25);border-radius:14px;margin-bottom:8px;}.admin-song-input{background:transparent;border:0;outline:0;color:white;font-weight:700;width:100%;}.upload-card{padding:25px;background:rgba(255,255,255,.04);border:2.5px dashed rgba(255,255,255,.2);border-radius:24px;text-align:center;cursor:pointer;}#msg-box{position:fixed;top:30px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--dynamic-accent);color:white;padding:15px 50px;border-radius:100px;font-weight:900;z-index:10000;transition:.5s;}.active#msg-box{transform:translateX(-50%) translateY(0);}.custom-scroll::-webkit-scrollbar{width:5px;}.custom-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:10px;}@media(max-width:768px){.desktop-container{display:none}.mobile-player-container{display:flex}}</style></head><body><div id="msg-box"></div><div id="bg-stage"></div><div id="lock-screen"><div class="p-8 bg-white/10 rounded-3xl backdrop-blur-3xl border border-white/20 w-[330px]"><h4 class="text-white font-black text-xl mb-6 text-center">Sarah MUSIC</h4><input id="auth-input" type="password" onkeydown="if(event.key==='Enter')handleAuth()" class="w-full bg-white/5 p-4 rounded-2xl text-white text-center mb-6 outline-none border border-white/10" placeholder="ËÆøÈóÆÂØÜÁ†Å"><button onclick="handleAuth()" class="w-full py-4 bg-[#4d7c5f] text-white rounded-2xl font-black">Ëß£ÈîÅ‰πêÂ∫ì</button></div></div><div id="sarah-dialog" class="modal" onclick="closeSarahDialog()"><div class="p-6 bg-[#1e293b] rounded-3xl w-[300px]" onclick="event.stopPropagation()"><h4 id="dialog-title" class="text-white font-black mb-4 text-center uppercase tracking-widest">ÊèêÁ§∫</h4><div id="dialog-input-wrap" class="hidden mb-4"><input id="dialog-input" class="w-full bg-white/10 p-3 rounded-xl text-white outline-none border border-white/10"></div><p id="dialog-msg" class="text-white/70 text-xs mb-6 text-center"></p><div class="flex gap-2"><button onclick="closeSarahDialog()" class="flex-1 py-3 bg-white/5 text-white rounded-xl text-[10px] font-black">ÂèñÊ∂à</button><button id="dialog-confirm" class="flex-1 py-3 bg-[#4d7c5f] text-white rounded-xl text-[10px] font-black">Á°ÆËÆ§</button></div></div></div><div id="playlist-selector-modal" class="modal" onclick="closePlaylistSelector()"><div class="p-6 bg-[#1e293b] rounded-3xl w-[300px]" onclick="event.stopPropagation()"><h4 class="text-white font-black text-sm mb-5 text-center">ÂàÜÂèëËá≥Ê≠åÂçï</h4><div id="playlist-selector-list" class="space-y-3 max-h-[350px] overflow-y-auto custom-scroll"></div></div></div><div class="desktop-container auth-hidden" id="main-ui"><header><h1 class="brand-title">Sarah</h1><div class="settings-corner"><div onclick="toggleAdmin(true)" class="btn-round !bg-white/10 border border-white/25 cursor-pointer"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></div></div></header><div class="search-panel"><div class="search-capsule"><input id="search-input" oninput="handleSearch()" placeholder="ÊêúÁ¥¢ÊóãÂæã..." class="search-input-field"><div onclick="clearSearch('search-input')" class="px-3 opacity-30 cursor-pointer">‚úï</div></div><button class="search-confirm-btn" onclick="handleSearch()">ÊêúÁ¥¢</button></div><main class="content-layout"><section class="panel-box p-6 items-center text-center"><div class="cover-container mx-auto" id="pc-cover-wrap"><div class="cover-placeholder" id="pc-logo-box"></div><img id="ui-cover" class="cover-img" style="display:none"></div><h2 id="ui-title" class="text-base font-black truncate w-full mb-1">Ê≠åÊõ≤Ê†áÈ¢ò</h2><p id="ui-artist" class="text-[11px] font-black opacity-40 uppercase truncate w-full"></p><button onclick="handleLikeToggle()" id="fav-trigger" class="mt-3 opacity-50"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg></button></section><section class="panel-box"><div id="tabs-scroll" class="p-3 border-b border-black/5 flex gap-4 overflow-x-auto custom-scroll"><div id="tab-play" onclick="switchList('all')" class="cursor-pointer active px-3 py-2 rounded-lg font-black text-xs">ÂÖ®Â∫ì</div><div id="tab-fav" onclick="switchList('fav')" class="cursor-pointer px-3 py-2 rounded-lg font-black text-xs">Êî∂Ëóè</div><div id="custom-tabs" class="flex gap-4"></div></div><div id="list-view" class="flex-1 overflow-y-auto custom-scroll list-transition"></div></section><section class="panel-box"><div id="lrc-view" class="lyrics-panel custom-scroll"></div></section></main><footer class="footer-bar"><div class="flex gap-2"><div onclick="toggleMode()" class="btn-round"><svg id="mode-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"></svg></div><div onclick="handlePrev()" class="btn-round">‚èÆ</div><div onclick="handlePlayToggle()" class="btn-round btn-main"><svg id="p-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"></svg></div><div onclick="handleNext()" class="btn-round">‚è≠</div></div><div class="scrubber-area"><span id="cur-time" class="opacity-30 text-xs">00:00</span><div id="pc-scrubber" class="rail" onmousedown="handleMouseSeekStart(event)"><div class="fill" id="prog-bar"><div class="dot"></div></div></div><span id="total-time" class="opacity-30 text-xs">00:00</span></div><div class="volume-control"><div onclick="toggleMute()" class="opacity-40 cursor-pointer"><svg id="v-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"></svg></div><div id="pc-vol-rail" class="volume-rail rail" onmousedown="handleMouseVolStart(event)"><div class="fill" id="vol-bar" style="width:70%"><div class="dot !w-3 !h-3"></div></div></div></div></footer></div><div id="m-player" class="mobile-player-container auth-hidden"><header class="m-header"><div onclick="toggleMobileDrawer(true)" class="btn-round !bg-transparent">üîç</div><h1 class="text-xl font-black">Sarah</h1><div onclick="toggleAdmin(true)" class="btn-round !bg-transparent">‚öôÔ∏è</div></header><main class="m-main"><div class="m-disc-container" id="m-disc-wrapper" onclick="handlePlayToggle()"><div class="m-disc-clipping"><div class="cover-placeholder" id="m-logo-box"></div><img id="m-ui-cover" style="display:none" class="w-full h-full object-cover"></div></div><div id="m-lrc-flow" class="m-lyrics-panel"></div><div class="m-info-wrap"><h2 id="m-ui-title" class="text-lg font-black truncate"></h2><div class="flex items-center justify-center gap-2 opacity-60 text-xs font-bold"><span id="m-ui-artist"></span><button onclick="handleLikeToggle()" id="m-fav-trigger">‚ô•</button></div></div></main><footer class="m-controls-capsule"><div id="m-scrubber-wrap" class="h-8 flex items-center" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)"><div class="rail !bg-white/10"><div class="fill !bg-white" id="m-prog-bar"><div class="dot !bg-[#4d7c5f]"></div></div></div></div><div class="flex justify-between text-[10px] text-white/50 mb-4"><span id="m-cur-time">00:00</span><span id="m-total-time">00:00</span></div><div class="flex items-center justify-between"><div onclick="toggleMode()" class="btn-round !bg-white !text-[#4d7c5f]"><svg id="m-mode-icon" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"></svg></div><div onclick="handlePrev()" class="btn-round !bg-white !text-[#4d7c5f]">‚èÆ</div><div onclick="handlePlayToggle()" class="btn-round btn-main !bg-white !text-[#4d7c5f]"><svg id="m-p-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"></svg></div><div onclick="handleNext()" class="btn-round !bg-white !text-[#4d7c5f]">‚è≠</div><div onclick="toggleMobileDrawer(true)" class="btn-round !bg-white !text-[#4d7c5f]">‚ò∞</div></div></footer></div><div id="m-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[999] hidden" onclick="toggleMobileDrawer(false);toggleAdmin(false)"></div><div id="m-drawer" class="m-drawer"><div id="m-pl-cards" class="flex gap-2 p-4 overflow-x-auto border-b border-white/10"></div><div class="p-4"><input id="m-list-search" oninput="handleMobileListSearch()" class="w-full bg-white/10 p-4 rounded-2xl text-white outline-none" placeholder="ÊêúÁ¥¢ÊóãÂæã..."></div><div id="m-list-view" class="flex-1 overflow-y-auto px-4 pb-10 list-transition"></div></div><div id="admin-panel" class="modal"><div id="admin-box"><div class="flex justify-between p-6 border-b border-white/10 text-white"><h3 class="text-xl font-black">ËÆæÁΩÆ</h3><div class="flex gap-2"><button onclick="toggleSleepArea()" class="w-10 h-10 bg-white/10 rounded-xl">‚è∞</button><button onclick="toggleUploadArea()" class="w-10 h-10 bg-white/10 rounded-xl">‚¨Ü</button><button onclick="toggleAdmin(false)" class="w-10 h-10 bg-white/20 rounded-xl">‚úï</button></div></div><div class="flex-1 overflow-y-auto p-6 custom-scroll"><div id="sleep-area" class="hidden mb-6 p-4 bg-white/5 rounded-2xl"><div class="grid grid-cols-5 gap-2"><button onclick="setSleep(15)" class="bg-white/10 py-3 rounded-xl text-white">15</button><button onclick="setSleep(30)" class="bg-white/10 py-3 rounded-xl text-white">30</button><button onclick="setSleep(60)" class="bg-white/10 py-3 rounded-xl text-white">60</button><button onclick="setSleep(0)" class="bg-red-500/20 py-3 rounded-xl text-red-300">ÂèñÊ∂à</button></div><p id="sleep-status" class="text-center text-[10px] text-white/50 mt-4 font-black"></p></div><div id="upload-area" class="hidden mb-6"><div class="upload-card"><input type="file" id="f-in" multiple onchange="previewTag(this)" class="hidden"><label for="f-in" class="cursor-pointer text-white text-xs font-black"><p id="file-count-tip">ÁÇπÂáªÈÄâÊã©Èü≥È¢ëÊñá‰ª∂</p></label></div><div id="upload-progress-list" class="mt-4 space-y-2"></div><button id="auto-sync-trigger" onclick="handleUp()" class="w-full mt-4 py-4 bg-[#4d7c5f] text-white rounded-2xl font-black">ÊâßË°å‰∫ëÂêåÊ≠•</button></div><div id="admin-playlist-tabs" class="flex gap-2 mb-4 overflow-x-auto"></div><div id="admin-song-list" class="space-y-2 min-h-[100px] relative"></div></div></div></div><div id="ap-hidden" class="hidden"></div><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script>
let ap=null,db=[],lrcLines=[],currentTab='all',tempMetaMap=new Map(),modeIdx=0,dbIndexMap=new Map(),lastVolume=0.7,isMuted=false,currentThemeIdx=-1,sleepEndTime=null,sleepTimerInt=null,isScrubbing=false,isDraggingVol=false,lastActiveFileId=null,longPressTimer=null,currentDraggedEl=null,dragPlaceholder=null,touchOffsetTop=0,libState={songs:[],favorites:[],playlists:[]};
const modes=['list','single','random'],DEFAULT_LOGO='https://tc.yang.pp.ua/file/logo/sarah(1).png',solaraTheme=[{bg:'#f2c9b1',accent:'#e67e51',deep:'#c06c3e'},{bg:'#c7f9cc',accent:'#2d6a4f',deep:'#1b4332'},{bg:'#f4acb7',accent:'#9d0208',deep:'#641212'},{bg:'#a2d2ff',accent:'#0077b6',deep:'#1e3a8a'},{bg:'#ede0d4',accent:'#7f5539',deep:'#4b3832'},{bg:'#1e293b',accent:'#f59e0b',deep:'#451a03'}];
const fmtTime=s=>{if(isNaN(s)||s<0)return"00:00";const m=Math.floor(s/60),sec=Math.floor(s%60);return(m<10?"0"+m:m)+":"+(sec<10?"0"+sec:sec)};
async function init(){if('serviceWorker'in navigator)navigator.serviceWorker.register('/sw.js');const p=localStorage.getItem('sarah_access_token')||"";try{const res=await fetch('/api/songs',{headers:{'X-Sarah-Password':p}});if(res.status===401){document.getElementById('lock-screen').classList.add('active');return;}document.getElementById('main-ui').classList.remove('auth-hidden');document.getElementById('m-player').classList.remove('auth-hidden');document.getElementById('lock-screen').classList.remove('active');const raw=await res.json();libState=Array.isArray(raw)?{songs:raw,favorites:JSON.parse(localStorage.getItem('sarah_favs')||'[]'),playlists:[]}:raw;db=libState.songs;buildIndexMap();renderCustomTabs();renderAllLists();setTimeout(()=>{setupPlayer();updateUIModes();updateVolUI(lastVolume)},100);updateBackground(true);refreshUIMetaAt(0)}catch(e){location.reload()}}
function buildIndexMap(){dbIndexMap.clear();db.forEach((s,i)=>dbIndexMap.set(s.file_id,i))}
function setupPlayer(){if(ap)ap.destroy();const p=localStorage.getItem('sarah_access_token')||"";ap=new APlayer({container:document.getElementById('ap-hidden'),lrcType:1,audio:db.map(s=>({name:s.title,artist:s.artist,cover:s.cover||DEFAULT_LOGO,url:'/api/stream?file_id='+s.file_id+'&auth='+p,lrc:s.lrc||'[00:00.00]ÊöÇÊó†Ê≠åËØç'}))});ap.on('play',()=>{const s='<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>';document.getElementById('p-icon').innerHTML=s;document.getElementById('m-p-icon').innerHTML=s;document.getElementById('m-disc-wrapper').classList.add('playing');refreshMeta();updateMediaSession()});ap.on('pause',()=>{const s='<path d="M8 5v14l11-7z"></path>';document.getElementById('p-icon').innerHTML=s;document.getElementById('m-p-icon').innerHTML=s;document.getElementById('m-disc-wrapper').classList.remove('playing')});ap.on('timeupdate',()=>{if(isScrubbing)return;const cur=ap.audio.currentTime,dur=ap.audio.duration||1,pct=(cur/dur*100)+'%';['prog-bar','m-prog-bar'].forEach(id=>document.getElementById(id).style.width=pct);['cur-time','m-cur-time'].forEach(id=>document.getElementById(id).innerText=fmtTime(cur));['total-time','m-total-time'].forEach(id=>document.getElementById(id).innerText=fmtTime(dur));syncLyrics(cur)});ap.on('listswitch',data=>refreshUIMetaByAudio(ap.list.audios[data.index!==undefined?data.index:ap.list.index]))}
function refreshMeta(){refreshUIMetaByAudio(ap.list.audios[ap.list.index])}
function refreshUIMetaByAudio(a){if(!a)return;const fid=new URLSearchParams(a.url.split('?')[1]).get('file_id'),idx=dbIndexMap.get(fid);if(idx!==undefined)refreshUIMetaAt(idx)}
function refreshUIMetaAt(idx){const s=db[idx];if(!s)return;if(lastActiveFileId!==s.file_id){const c=document.getElementById('m-clipping-node');if(c){c.style.animation='none';void c.offsetWidth;c.style.animation=''};lastActiveFileId=s.file_id}const up=(imgId,boxId)=>{const img=document.getElementById(imgId),box=document.getElementById(boxId);if(s.cover){img.src=s.cover;img.style.display='block';box.style.display='none'}else{img.style.display='none';box.style.display='flex'}};up('ui-cover','pc-logo-box');up('m-ui-cover','m-logo-box');['ui-title','m-ui-title'].forEach(id=>document.getElementById(id).innerText=s.title);['ui-artist','m-ui-artist'].forEach(id=>document.getElementById(id).innerText=s.artist);const p=/[(d+):(d+).(d+)](.*)/;lrcLines=(s.lrc||"").split(/
/).map(l=>{const m=p.exec(l);return m?{t:parseInt(m[1])*60+parseInt(m[2]),text:m[4].trim()}:null}).filter(v=>v&&v.text);const rl=id=>{const el=document.getElementById(id);if(lrcLines.length===0){el.innerHTML='<div class="lrc-line active !opacity-30">ÊöÇÊó†Ê≠åËØç</div>';el.classList.add('justify-center')}else{el.classList.remove('justify-center');el.innerHTML='<div class="h-[65px]"></div>'+lrcLines.map((l,i)=>'<div class="lrc-line" id="'+id+'-lrc-'+i+'" onclick="ap.seek('+l.t+')">'+l.text+'</div>').join('')+'<div class="h-[65px]"></div>'}};rl('lrc-view');rl('m-lrc-flow');updateHighlights(s.file_id)}
function syncLyrics(t){if(lrcLines.length===0)return;let a=-1;for(let i=0;i<lrcLines.length;i++)if(t>=lrcLines[i].t)a=i;if(a!==-1)['lrc-view','m-lrc-flow'].forEach(id=>{const v=document.getElementById(id);v.querySelectorAll('.lrc-line').forEach((el,i)=>el.classList.toggle('active',i===a));const tg=document.getElementById(id+'-lrc-'+a);if(tg)v.scrollTo({top:tg.offsetTop-v.offsetHeight/2+tg.offsetHeight/2,behavior:'smooth'})})}
function updateHighlights(id){document.querySelectorAll('.song-item').forEach(el=>el.classList.toggle('active',el.dataset.id===id));const isF=libState.favorites.includes(id);['fav-trigger','m-fav-trigger'].forEach(hid=>{const el=document.getElementById(hid);if(el){el.style.color=isF?'#ef4444':'inherit';el.querySelector('svg')?.setAttribute('fill',isF?'currentColor':'none')}})}
function renderAllLists(){const isM=window.innerWidth<=768,q=document.getElementById(isM?'m-list-search':'search-input').value.toLowerCase();let ld=(currentTab==='all'?db:(currentTab==='fav'?libState.favorites.map(id=>db[dbIndexMap.get(id)]):libState.playlists[parseInt(currentTab)]?.ids.map(id=>db[dbIndexMap.get(id)]))).filter(Boolean);if(q)ld=ld.filter(s=>s.title.toLowerCase().includes(q)||s.artist.toLowerCase().includes(q));const curIdx=ap?ap.list.index:-1,curFid=curIdx!==-1?new URLSearchParams(ap.list.audios[curIdx].url.split('?')[1]).get('file_id'):null;const html=ld.map(s=>'<div class="song-item group '+(s.file_id===curFid?'active':'')+'" data-id="'+s.file_id+'" onclick="handleTrackSwitch('+dbIndexMap.get(s.file_id)+',''+s.file_id+'')"><img src="'+(s.cover||DEFAULT_LOGO)+'" class="w-10 h-10 rounded-lg object-cover"><div class="flex-1 truncate"><div class="text-[13px] font-bold truncate">'+s.title+'</div><div class="text-[10px] opacity-50 truncate uppercase">'+s.artist+'</div></div></div>').join('')||'<div class="py-20 text-center opacity-20 font-black">ÂàóË°®ÊöÇÊó†ÊóãÂæã</div>';document.getElementById('list-view').innerHTML=html;document.getElementById('m-list-view').innerHTML=html}
async function handleTrackSwitch(i,fid){if(!ap)return;let ti=i;if(fid){const fi=ap.list.audios.findIndex(a=>a.url.includes('file_id='+fid));if(fi!==-1)ti=fi}ap.list.switch(ti);ap.play()}
function toggleMode(){modeIdx=(modeIdx+1)%modes.length;updateUIModes()}
function updateUIModes(){const m=modes[modeIdx];if(ap){ap.options.loop=m==='single'?'one':'all';ap.options.order=m==='random'?'random':'list'}const ics={list:'<path d="M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"></path>',single:'<path d="M11 9h1v6M10 15h3M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"></path>',random:'<path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5"></path>'};document.getElementById('mode-icon').innerHTML=ics[m];document.getElementById('m-mode-icon').innerHTML=ics[m]}
function handlePlayToggle(){if(!ap)return;ap.paused?ap.play():ap.pause()}
function handlePrev(){if(!ap)return;handleTrackSwitch((ap.list.index-1+ap.list.audios.length)%ap.list.audios.length)}
function handleNext(){if(!ap)return;handleTrackSwitch((ap.list.index+1)%ap.list.audios.length)}
function updateVolUI(p){const vBar=document.getElementById('vol-bar'),vIcon=document.getElementById('v-icon');if(vBar)vBar.style.width=(p*100)+'%';if(vIcon)vIcon.innerHTML=p===0?'<path d="M11 5L6 9H2v6h4l5 4V5zM22 9l-6 6m0-6l6 6"></path>':(p<.5?'<path d="M11 5L6 9H2v6h4l5 4V5zM15.54 8.46a5 5 0 0 1 0 7.07"></path>':'<path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>')}
async function handleUp(){const input=document.getElementById('f-in'),fs=Array.from(input.files);if(!fs.length)return;const btn=document.getElementById('auto-sync-trigger'),plist=document.getElementById('upload-progress-list');btn.disabled=true;plist.innerHTML=fs.map((f,i)=>'<div class="bg-white/5 p-3 rounded-xl" id="up-item-'+i+'"><div class="flex justify-between text-[10px] text-white/70 mb-1"><span class="truncate">'+f.name+'</span><span class="pct">ÈòüÂàó‰∏≠</span></div><div class="h-1 bg-white/10 rounded-full overflow-hidden"><div class="bar h-full bg-amber-600 transition-all" style="width:0%"></div></div></div>').join('');const pass=localStorage.getItem('sarah_access_token')||"",q=[...fs.keys()],upWorker=async()=>{while(q.length>0){const i=q.shift(),f=fs[i],fd=new FormData();fd.append('file',f);await new Promise(res=>{const xhr=new XMLHttpRequest();xhr.open('POST','/api/upload');xhr.setRequestHeader('X-Sarah-Password',pass);xhr.upload.onprogress=e=>{if(e.lengthComputable){const p=Math.round(e.loaded/e.total*100);const row=document.getElementById('up-item-'+i);row.querySelector('.bar').style.width=p+'%';row.querySelector('.pct').innerText=p+'%'}};xhr.onload=()=>{if(xhr.status===200){const r=JSON.parse(xhr.responseText);db.unshift({...tempMetaMap.get(f.name)||{title:f.name.replace(/.[^/.]+$/,""),artist:"Êú™Áü•"},file_id:r.file_id});document.getElementById('up-item-'+i).querySelector('.pct').innerText="‚úÖ"};res()};xhr.send(fd)})}};await Promise.all([upWorker(),upWorker(),upWorker()]);libState.songs=db;await saveSync(false);renderAdminSongList();btn.disabled=false;input.value=""}
async function saveSync(reload){const pass=localStorage.getItem('sarah_access_token')||"";try{const res=await fetch('/api/manage',{method:'POST',headers:{'X-Sarah-Password':pass},body:JSON.stringify({data:libState})});if((await res.json()).success){buildIndexMap();renderAllLists();renderCustomTabs();renderAdminPlaylistTabs();if(reload)location.reload()}}catch(e){}}
function handleAuth(){const p=document.getElementById('auth-input').value;if(!p)return;fetch('/api/songs',{headers:{'X-Sarah-Password':p}}).then(r=>r.status===200?(localStorage.setItem('sarah_access_token',p),init()):showMsg("ÂØÜÁ†ÅÈîôËØØ"))}
function switchList(t){currentTab=t;const containers=[document.getElementById('list-view'),document.getElementById('m-list-view')];containers.forEach(el=>el.classList.add('entering'));setTimeout(()=>{updateBackground(false);renderAllLists();if(document.getElementById('admin-panel').classList.contains('active'))renderAdminSongList();containers.forEach(el=>el.classList.remove('entering'))},50)}
function updateBackground(f){if(f)currentThemeIdx=Math.floor(Math.random()*solaraTheme.length);const t=solaraTheme[currentThemeIdx],m=window.innerWidth<=768;document.body.style.backgroundColor=m?'#4d7c5f':t.bg;document.getElementById('bg-stage').style.background=m?'#4d7c5f':'linear-gradient(135deg,'+t.bg+' 0%,'+t.deep+' 100%)';document.documentElement.style.setProperty('--dynamic-accent',m?'#ffffff':t.accent)}
function handleSearch(){renderAllLists()}
function clearSearch(id){document.getElementById(id).value="";renderAllLists()}
function toggleAdmin(s){document.getElementById('admin-panel').classList.toggle('active',s);if(s){renderAdminPlaylistTabs();renderAdminSongList()}}
function toggleUploadArea(){document.getElementById('upload-area').classList.toggle('hidden')}
function toggleSleepArea(){document.getElementById('sleep-area').classList.toggle('hidden')}
function setSleep(m){if(sleepTimerInt)clearInterval(sleepTimerInt);const s=document.getElementById('sleep-status');if(m===0){sleepEndTime=null;s.innerText=""}else{sleepEndTime=Date.now()+m*60000;sleepTimerInt=setInterval(()=>{const d=sleepEndTime-Date.now();if(d<=0){ap.pause();clearInterval(sleepTimerInt);s.innerText=""}else s.innerText="Áù°Áú†ÂÆöÊó∂: "+Math.floor(d/60000)+":"+(Math.floor(d/1000)%60).toString().padStart(2,'0')},1000)}}
function handleLikeToggle(){const c=ap.list.audios[ap.list.index];if(!c)return;const id=new URLSearchParams(c.url.split('?')[1]).get('file_id'),i=libState.favorites.indexOf(id);i>-1?libState.favorites.splice(i,1):libState.favorites.push(id);updateHighlights(id);saveSync(false)}
function showMsg(t){const b=document.getElementById('msg-box');b.innerText=t;b.classList.add('active');setTimeout(()=>b.classList.remove('active'),3000)}
function previewTag(i){const fs=Array.from(i.files);fs.forEach(f=>jsmediatags.read(f,{onSuccess:t=>{const{title,artist,picture,lyrics}=t.tags;let cv='';if(picture){const{data,format}=picture;let b64="";for(let j=0;j<data.length;j++)b64+=String.fromCharCode(data[j]);cv='data:'+format+';base64,'+window.btoa(b64)}tempMetaMap.set(f.name,{title:title||f.name.replace(/.[^/.]+$/,""),artist:artist||"Êú™Áü•",cover:cv,lrc:lyrics?lyrics.lyrics:""})}}))}
function renderAdminPlaylistTabs(){const c=document.getElementById('admin-playlist-tabs');if(!c)return;c.innerHTML=['all','fav',...libState.playlists.keys()].map(k=>{const name=k==='all'?'ÂÖ®Â∫ì':(k==='fav'?'Êî∂Ëóè':libState.playlists[k].name);return '<div class="px-4 py-2 bg-white/10 rounded-lg text-white text-xs cursor-pointer '+(currentTab===k.toString()?'!bg-amber-600':'')+'" onclick="switchList(''+k+'')">'+name+'</div>'}).join('')}
function renderAdminSongList(){const c=document.getElementById('admin-song-list'),ld=(currentTab==='all'?db:(currentTab==='fav'?libState.favorites.map(id=>db[dbIndexMap.get(id)]):libState.playlists[parseInt(currentTab)]?.ids.map(id=>db[dbIndexMap.get(id)]))).filter(Boolean);c.innerHTML=ld.map((s,i)=>'<div class="admin-song-row text-white text-xs" data-fileid="'+s.file_id+'"><span>'+s.title+'</span><div class="ml-auto flex gap-2"><button onclick="deleteFromContext('+i+',''+s.file_id+'')">üóë</button></div></div>').join('')}
function deleteFromContext(i,fid){if(confirm("Á°ÆÂÆöÂà†Èô§?")){if(currentTab==='all'){db=db.filter(s=>s.file_id!==fid);libState.songs=db;libState.favorites=libState.favorites.filter(id=>id!==fid)}else if(currentTab==='fav')libState.favorites=libState.favorites.filter(id=>id!==fid);else libState.playlists[parseInt(currentTab)].ids=libState.playlists[parseInt(currentTab)].ids.filter(id=>id!==fid);renderAdminSongList();saveSync(false)}}
function handleAuth(){const p=document.getElementById('auth-input').value;fetch('/api/songs',{headers:{'X-Sarah-Password':p}}).then(r=>r.status===200?(localStorage.setItem('sarah_access_token',p),init()):showMsg("ÂØÜÁ†ÅÈîôËØØ"))}
window.onload=init;</script></body></html>